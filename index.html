<!DOCTYPE html>
<html lang="en" dir="ltr">

  <head>
    <title>Beetus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        padding: 0 2ex;
        font-size: 16pt;
        max-width: 42ex;
        margin: 0 auto;
      }
      input {
        font-size: 16pt;
        font-family: monospace;
        width: 5ch;
      }
      div.row {
        text-align: center;
        margin-bottom: 0.5em;
      }
      div.logo {
        text-align: center;
        margin-bottom: 2em;
      }
      div.logo span {
        writing-mode: vertical-lr;
        font-size: 128pt;
        color: #ccc;
      }
      hr {
        margin: 1em auto;
        border-color: #ccc;
      }
    </style>
  </head>

  <body>

    <div class="logo"><span>{</span></div>

    <form method="GET">
      <div class="row">
        1 unit for every
        <input type="number" placeholder="40" id="carbsRatio" name="carbsRatio" />
        carbs
      </div>
      <div class="row">
        (blood glucose -
        <input type="number" placeholder="150" id="bloodGlucoseOffset" name="bloodGlucoseOffset" />)
        / 
        <input type="number" placeholder="100" id="bloodGlucoseRatio" name="bloodGlucoseRatio" />
      </div>

      <hr>

      <table align="center">
        <tr>
          <td align="right">
            <label for="c">Carbs:</label>
          </td>
          <td>
            <input type="number" placeholder="0" id="carbs" name="carbs" />
          </td>
        </tr>
        <tr>
          <td align="right">
            <label for="g">Blood glucose:</label>
          </td>
          <td>
            <input type="number" placeholder="0" id="bloodGlucose" name="bloodGlucose" />
          </td>
        </tr>
      </table>

      <hr>

      <table align="center">
        <tr>
          <td align="right">
            Date calculated:
          </td>
          <td>
            <span id="date"></span>
          </td>
        </tr>
        <tr>
          <td align="right">
            Time calculated:
          </td>
          <td>
            <span id="time"></span>
          </td>
        </tr>
        <tr height="20">
          <td colspan="2"></td>
        </tr>
        <tr>
          <td align="right">
            Insulin for carbs:
          </td>
          <td>
            <span id="carbsUnits"></span> units
          </td>
        </tr>
        <tr>
          <td align="right">
            Insulin for blood sugar:
          </td>
          <td>
            <span id="bloodGlucoseUnits"></span> units
          </td>
        </tr>
      </table>

      <hr>

      <table align="center">
        <tr>
          <td align="right">
            <b>Total insulin dose:</b>
          </td>
          <td>
            <b><span id="total"></span> units</b>
          </td>
        </tr>
      </table>

    </form>

    <script>
      function round(sum) {
        var whole = Math.trunc(sum);
        var remainder = sum - whole;

        var round;

        if (remainder <= 0.2) {
          round = 0;
        } else if (remainder < 0.8) {
          round = 0.5;
        } else {
          round = 1;
        }

        return Math.max(0, whole + round);
      }

      var bloodGlucoseOffset = document.getElementById("bloodGlucoseOffset");
      var bloodGlucoseRatio = document.getElementById("bloodGlucoseRatio");

      var carbsRatio = document.getElementById("carbsRatio");

      var bloodGlucose = document.getElementById("bloodGlucose");
      var carbs = document.getElementById("carbs");

      var theDate = document.getElementById("date");
      var theTime = document.getElementById("time");
      var carbsUnits = document.getElementById("carbsUnits");
      var bloodGlucoseUnits = document.getElementById("bloodGlucoseUnits");
      var total = document.getElementById("total");

      function go() {

        var now = new Date();

        theDate.innerHTML =
          now.toLocaleString(
            "en-us",
            {
              year: "numeric",
              month: "short",
              day: "numeric",
            }
          );

        theTime.innerHTML =
          now.toLocaleTimeString(
            "en-us",
            {
              hour: "2-digit",
              minute: "2-digit",
            }
          );

        var carbsRatioValue =
          carbsRatio.value || carbsRatio.placeholder;

        var carbsValue =
          carbs.value || carbs.placeholder;

        var bloodGlucoseValue =
          bloodGlucose.value || bloodGlucose.placeholder;

        var bloodGlucoseOffsetValue =
          bloodGlucoseOffset.value || bloodGlucoseOffset.placeholder;

        var bloodGlucoseRatioValue =
          bloodGlucoseRatio.value || bloodGlucoseRatio.placeholder;

        var carbsCorrection = carbsValue / carbsRatioValue;
        carbsUnits.innerHTML = Math.max(0, carbsCorrection.toFixed(2));

        var sugarCorrection =
          (bloodGlucoseValue - bloodGlucoseOffsetValue) / bloodGlucoseRatioValue;
        bloodGlucoseUnits.innerHTML = Math.max(0, sugarCorrection.toFixed(2));

        var totalCorrection = round(sugarCorrection + carbsCorrection);
        total.innerHTML = totalCorrection;
      }

      [
        carbsRatio,
        bloodGlucoseOffset,
        bloodGlucoseRatio,
        carbs,
        bloodGlucose
      ].forEach((x) => {
          x.onchange = go;
          x.onkeypress = go;
          x.onpaste = go;
          x.oninput = go;
      });

      carbs.focus();

      go();
    </script>
  </body>
</html>
